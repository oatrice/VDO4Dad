name: CI/CD Pipeline

on:
  push:
    branches:
      - 'main'
      - 'master'
      - 'feature/**'  # Any branch that starts with 'feature/'
  pull_request:
    branches: [ main, master ]

jobs:
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run unit tests
      run: npm test
  
  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20  # Fail if tests run longer than 20 minutes
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Cache Playwright browsers
      uses: actions/cache@v3
      with:
        path: ~/.cache/ms-playwright
        key: ${{ runner.os }}-browsers-${{ hashFiles('package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-browsers-
    
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps chromium
      
    - name: Run Playwright tests
      timeout-minutes: 15  # Fail individual test step if it takes too long
      run: npm run test:e2e -- --workers=2  # Run tests with 2 workers in parallel
      
  deploy:
    name: Deploy
    needs: [unit-test, e2e-test]  # Wait for both test jobs to complete
    timeout-minutes: 15
    # Only run on main/master branch
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18.x'
    
    - name: Install dependencies
      run: npm ci --production
      
    # Add deployment steps here based on your hosting platform
    # For example, for Vercel, Netlify, or GitHub Pages
    - name: Deploy to production
      run: echo "Add your deployment steps here"
      # Example for GitHub Pages:
      # run: |
      #   npm run build
      #   cd build
      #   touch .nojekyll
      #   git init
      #   git config user.name "GitHub Actions"
      #   git config user.email "actions@github.com"
      #   git add .
      #   git commit -m "Deploy to GitHub Pages"
      #   git push --force --quiet "https://${{ github.actor }}:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" main:gh-pages
